<script>
let portfolioData = [
Â  Â  { scrip: 'SHIVM', sector: 'Manufacturing And Processing', quantity: 190, purchasePrice: 515, ltp: 515, recommendation: 'HOLD', rationale: 'Newly added blue-chip manufacturing stock. Excellent for diversification.' },
Â  Â  { scrip: 'DDBL', sector: 'Microfinance', quantity: 120, purchasePrice: 780, ltp: 782.11, recommendation: 'HOLD', rationale: 'High-quality MFI. Core holding for the sector.' },
Â  Â  { scrip: 'AKJCL', sector: 'Hydro Power', quantity: 200, purchasePrice: 211.90, ltp: 209.88, recommendation: 'HOLD', rationale: 'New holding. Monitor speculative P/E and dilutive rights issue.' },
Â  Â  { scrip: 'HDL', sector: 'Manufacturing And Processing', quantity: 43, purchasePrice: 1181.36, ltp: 1209, recommendation: 'HOLD', rationale: 'Excellent fundamentals, key diversifier.' },
Â  Â  { scrip: 'KBL', sector: 'Commercial Banks', quantity: 100, purchasePrice: 213.05, ltp: 219, recommendation: 'SELL', rationale: 'Consolidate banking exposure to simplify.' },
Â  Â  { scrip: 'SKBBL', sector: 'Microfinance', quantity: 39, purchasePrice: 668.17, ltp: 840, recommendation: 'HOLD', rationale: 'Strongest MFI holding, consistent dividends.' },
Â  Â  { scrip: 'RSDC', sector: 'Microfinance', quantity: 39, purchasePrice: 409.62, ltp: 732, recommendation: 'REDUCE', rationale: 'Reduce to consolidate capital into stronger MFIs.' },
Â  Â  { scrip: 'GBIME', sector: 'Commercial Banks', quantity: 300, purchasePrice: 222.33, ltp: 230, recommendation: 'HOLD', rationale: 'Core holding, but monitor high NPLs (4.98%).' },
Â  Â  { scrip: 'FMDBL', sector: 'Microfinance', quantity: 17, purchasePrice: 474.93, ltp: 809, recommendation: 'SELL', rationale: 'ðŸ”´ Extreme P/E. High risk. Sell to de-risk.' },
Â  Â  { scrip: 'SRLI', sector: 'Life Insurance', quantity: 20, purchasePrice: 100, ltp: 446.8, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
Â  Â  { scrip: 'NBF2', sector: 'Mutual Fund', quantity: 100, purchasePrice: 10, ltp: 9.45, recommendation: 'SELL', rationale: 'Position size is too small to have any impact.' },
Â  Â  { scrip: 'HRL', sector: 'Others', quantity: 31, purchasePrice: 202.58, ltp: 1029.9, recommendation: 'REDUCE', rationale: 'ðŸŸ¡ Valuation Risk: High P/E suggests speculation.' },
Â  Â  { scrip: 'HLI', sector: 'Life Insurance', quantity: 23, purchasePrice: 100.45, ltp: 431, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
Â  Â  { scrip: 'GCIL', sector: 'Manufacturing And Processing', quantity: 11, purchasePrice: 404.55, ltp: 577.5, recommendation: 'SELL', rationale: 'ðŸ”´ Negative Earnings: Unprofitable company.' },
Â  Â  { scrip: 'CLI', sector: 'Life Insurance', quantity: 10, purchasePrice: 244, ltp: 721.5, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
Â  Â  { scrip: 'USHEC', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 696, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
Â  Â  { scrip: 'UPPER', sector: 'Hydro Power', quantity: 80, purchasePrice: 100, ltp: 209.7, recommendation: 'SELL', rationale: 'Sell to reduce overall hydropower exposure.' },
Â  Â  { scrip: 'UPCL', sector: 'Hydro Power', quantity: 54, purchasePrice: 100, ltp: 306.9, recommendation: 'REDUCE', rationale: 'Reduce exposure to hydropower sector policy risk.' },
Â  Â  { scrip: 'UAIL', sector: 'Non-Life Insurance', quantity: 27, purchasePrice: 428.7, ltp: 703, recommendation: 'HOLD', rationale: 'Provides diversification into the non-life space.' },
Â  Â  { scrip: 'SNLI', sector: 'Life Insurance', quantity: 10, purchasePrice: 239, ltp: 725, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
Â  Â  { scrip: 'SJCL', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 356, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
Â  Â  { scrip: 'SGHC', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 577, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
Â  Â  { scrip: 'RNLI', sector: 'Life Insurance', quantity: 11, purchasePrice: 100, ltp: 567, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
Â  Â  { scrip: 'RHGCL', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 652, recommendation: 'SELL', rationale: 'ðŸ”´ Negative Earnings & Dilution Risk.' },
Â  Â  { scrip: 'PRVU', sector: 'Commercial Banks', quantity: 366, purchasePrice: 142.45, ltp: 231.1, recommendation: 'HOLD', rationale: 'Core bank, but watch asset quality issues.' },
Â  Â  { scrip: 'PPCL', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 320, recommendation: 'SELL', rationale: 'Small holding in a company with a history of losses.' },
Â  Â  { scrip: 'PMLI', sector: 'Life Insurance', quantity: 32, purchasePrice: 496.24, ltp: 587.9, recommendation: 'SELL', rationale: 'ðŸ”´ Zero Earnings: No fundamental reason to hold.' },
Â  Â  { scrip: 'NMB', sector: 'Commercial Banks', quantity: 133, purchasePrice: 231.31, ltp: 263, recommendation: 'SELL', rationale: 'Consolidate banking exposure into stronger core holdings.' },
Â  Â  { scrip: 'NIMB', sector: 'Commercial Banks', quantity: 300, purchasePrice: 194.63, ltp: 229, recommendation: 'HOLD', rationale: 'Strong fundamentals, attractive valuation.' },
Â  Â  { scrip: 'NIFRA', sector: 'Investment', quantity: 183, purchasePrice: 339.8, ltp: 296, recommendation: 'HOLD', rationale: 'Strategic asset, successful Green Bond issue.' },
Â  Â  { scrip: 'NICLBSL', sector: 'Microfinance', quantity: 10, purchasePrice: 100, ltp: 707.7, recommendation: 'SELL', rationale: 'ðŸ”´ Extreme Valuation: P/E over 6000 is a major red flag.' },
Â  Â  { scrip: 'JOSHI', sector: 'Hydro Power', quantity: 20, purchasePrice: 100, ltp: 414.5, recommendation: 'SELL', rationale: 'Non-strategic, small holding in a high-risk sector.' },
Â  Â  { scrip: 'GLH', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 270.1, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
Â  Â  { scrip: 'AVYAN', sector: 'Microfinance', quantity: 10, purchasePrice: 100, ltp: 1199, recommendation: 'SELL', rationale: 'ðŸ”´ Very high P/E ratio. Sell to reduce risk.' }
];

let sortState = {
Â  Â  column: 'currentValue',
Â  Â  direction: 'desc'
};

/**
 * Main entry point: Executes when the page content is loaded.
 * Fetches live prices silently and then sets up all user interactions.
 */
document.addEventListener('DOMContentLoaded', async () => {
Â  Â  await fetchLtpFromApi(false); // Fetch prices silently on load
Â  Â  setupEventListeners(); // Setup all interactive elements like buttons, tabs, etc.
});

function runAllCalculations() {
Â  Â  calculatePortfolioMetrics();
Â  Â  renderHoldingsTable();
Â  Â  renderActionsTable();
}

function setupEventListeners() {
Â  Â  setupTabs();
Â  Â  setupSorting();
Â  Â  setupFiltering();
Â  Â  setupAIButton();
Â  Â  setupModal();
Â  Â  setupAddStockForm();
Â  Â  setupDeleteStock();
Â  Â  setupApiSync();
}

function calculatePortfolioMetrics() {
Â  Â  let totalCurrentValue = 0;
Â  Â  let totalPurchaseValue = 0;

Â  Â  portfolioData.forEach(item => {
Â  Â  Â  Â  item.purchaseValue = item.quantity * item.purchasePrice;
Â  Â  Â  Â  item.currentValue = item.quantity * item.ltp;
Â  Â  Â  Â  item.profitOrLoss = item.currentValue - item.purchaseValue;
Â  Â  Â  Â  item.profitOrLossPercent = item.purchaseValue > 0 ? (item.profitOrLoss / item.purchaseValue) * 100 : 0;
Â  Â  Â  Â  totalCurrentValue += item.currentValue;
Â  Â  Â  Â  totalPurchaseValue += item.purchaseValue;
Â  Â  });

Â  Â  portfolioData.forEach(item => {
Â  Â  Â  Â  item.weight = totalCurrentValue > 0 ? (item.currentValue / totalCurrentValue) * 100 : 0;
Â  Â  });

Â  Â  const totalPL = totalCurrentValue - totalPurchaseValue;
Â  Â  const portfolioReturn = totalPurchaseValue > 0 ? (totalPL / totalPurchaseValue) * 100 : 0;

Â  Â  document.getElementById('totalValue').textContent = `NPR ${totalCurrentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
Â  Â  document.getElementById('totalInvestment').textContent = `NPR ${totalPurchaseValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
Â  Â  
Â  Â  const totalPLElement = document.getElementById('totalPL');
Â  Â  totalPLElement.textContent = `NPR ${totalPL.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
Â  Â  totalPLElement.className = `text-2xl font-semibold mt-2 ${totalPL >= 0 ? 'profit' : 'loss'}`;

Â  Â  const portfolioReturnElement = document.getElementById('portfolioReturn');
Â  Â  portfolioReturnElement.textContent = `${portfolioReturn.toFixed(2)}%`;
Â  Â  portfolioReturnElement.className = `text-2xl font-semibold mt-2 ${portfolioReturn >= 0 ? 'profit' : 'loss'}`;
}

function setupModal() {
Â  Â  const modal = document.getElementById('addStockModal');
Â  Â  const openBtn = document.getElementById('openModalBtn');
Â  Â  const closeBtn = document.getElementById('closeModalBtn');
Â  Â  openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
Â  Â  closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
Â  Â  window.addEventListener('click', (event) => {
Â  Â  Â  Â  if (event.target === modal) {
Â  Â  Â  Â  Â  Â  modal.classList.add('hidden');
Â  Â  Â  Â  }
Â  Â  });
}

function setupAddStockForm() {
Â  Â  const form = document.getElementById('addStockForm');
Â  Â  form.addEventListener('submit', (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const scripInput = document.getElementById('scrip');
Â  Â  Â  Â  const sharesInput = document.getElementById('shares');
Â  Â  Â  Â  const priceInput = document.getElementById('price');
Â  Â  Â  Â  
Â  Â  Â  Â  const newStock = {
Â  Â  Â  Â  Â  Â  scrip: scripInput.value.toUpperCase(),
Â  Â  Â  Â  Â  Â  sector: 'Uncategorized',
Â  Â  Â  Â  Â  Â  quantity: parseFloat(sharesInput.value),
Â  Â  Â  Â  Â  Â  purchasePrice: parseFloat(priceInput.value),
Â  Â  Â  Â  Â  Â  ltp: parseFloat(priceInput.value),
Â  Â  Â  Â  Â  Â  recommendation: 'HOLD',
Â  Â  Â  Â  Â  Â  rationale: 'Newly added stock. Analysis pending.'
Â  Â  Â  Â  };

Â  Â  Â  Â  if (newStock.scrip && !isNaN(newStock.quantity) && !isNaN(newStock.purchasePrice)) {
Â  Â  Â  Â  Â  Â  portfolioData.push(newStock);
Â  Â  Â  Â  Â  Â  runAllCalculations();
Â  Â  Â  Â  Â  Â  form.reset();
Â  Â  Â  Â  Â  Â  document.getElementById('addStockModal').classList.add('hidden');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert('Please fill in all fields correctly.');
Â  Â  Â  Â  }
Â  Â  });
}

function setupDeleteStock() {
Â  Â  const tableBody = document.getElementById('holdingsTableBody');
Â  Â  tableBody.addEventListener('click', (e) => {
Â  Â  Â  Â  if (e.target.closest('.delete-btn')) {
Â  Â  Â  Â  Â  Â  const scripToDelete = e.target.closest('.delete-btn').dataset.scrip;
Â  Â  Â  Â  Â  Â  portfolioData = portfolioData.filter(stock => stock.scrip !== scripToDelete);
Â  Â  Â  Â  Â  Â  runAllCalculations();
Â  Â  Â  Â  }
Â  Â  });
}

/**
 * Sets up the event listener for the manual "Sync Live Prices" button.
 */
function setupApiSync() {
Â  Â  const syncBtn = document.getElementById('syncLtpBtn');
Â  Â  syncBtn.addEventListener('click', () => fetchLtpFromApi(true));
}

/**
 * Fetches LTP from the API, updates portfolio data, re-renders the UI,
 * and optionally shows alerts to the user.
 * @param {boolean} showAlerts - If true, displays success/error alerts.
 */
async function fetchLtpFromApi(showAlerts = true) {
Â  Â  const syncBtn = document.getElementById('syncLtpBtn');
Â  Â  const syncBtnText = document.getElementById('syncBtnText');
Â  Â  const originalBtnText = 'Sync Live Prices';

Â  Â  syncBtn.disabled = true;
Â  Â  syncBtnText.textContent = 'Syncing...';

Â  Â  try {
Â  Â  Â  Â  const response = await fetch('https://nepsefloorsheetapi.onrender.com/api/v1/share-prices');
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`API Error: ${response.status} ${response.statusText}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const apiData = await response.json();
Â  Â  Â  Â  
Â  Â  Â  Â  if (!Array.isArray(apiData) || apiData.length === 0) {
Â  Â  Â  Â  Â  Â  if (showAlerts) alert("Received no data from the API.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const priceMap = new Map();
Â  Â  Â  Â  apiData.forEach(item => {
Â  Â  Â  Â  Â  Â  const symbol = item.Symbol;
Â  Â  Â  Â  Â  Â  const ltp = parseFloat(String(item.LTP).replace(/,/g, ''));
Â  Â  Â  Â  Â  Â  if (symbol && !isNaN(ltp)) {
Â  Â  Â  Â  Â  Â  Â  Â  priceMap.set(symbol, ltp);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  let updatedCount = 0;
Â  Â  Â  Â  portfolioData.forEach(stock => {
Â  Â  Â  Â  Â  Â  if (priceMap.has(stock.scrip)) {
Â  Â  Â  Â  Â  Â  Â  Â  stock.ltp = priceMap.get(stock.scrip);
Â  Â  Â  Â  Â  Â  Â  Â  updatedCount++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (showAlerts) {
Â  Â  Â  Â  Â  Â  if (updatedCount > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`${updatedCount} stock(s) updated successfully with the latest prices.`);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("No matching stocks found in the live data to update.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Failed to fetch live prices:', error);
Â  Â  Â  Â  if (showAlerts) {
Â  Â  Â  Â  Â  Â  alert(`Could not fetch live prices. Please check your connection or try again later.\nError: ${error.message}`);
Â  Â  Â  Â  }
Â  Â  } finally {
Â  Â  Â  Â  // Always re-calculate and render the UI after the fetch attempt.
Â  Â  Â  Â  runAllCalculations();
Â  Â  Â  Â  // Always restore the button to its original state.
Â  Â  Â  Â  syncBtn.disabled = false;
Â  Â  Â  Â  syncBtnText.textContent = originalBtnText;
Â  Â  }
}


function setupTabs() {
Â  Â  const tabs = document.getElementById('tabs');
Â  Â  const tabContent = document.getElementById('tab-content');
Â  Â  tabs.addEventListener('click', (e) => {
Â  Â  Â  Â  if (e.target.tagName === 'BUTTON') {
Â  Â  Â  Â  Â  Â  const tabName = e.target.dataset.tab;
Â  Â  Â  Â  Â  Â  tabs.querySelectorAll('button').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('tab-active');
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('tab-inactive');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  e.target.classList.add('tab-active');
Â  Â  Â  Â  Â  Â  e.target.classList.remove('tab-inactive');
Â  Â  Â  Â  Â  Â  tabContent.querySelectorAll(':scope > div').forEach(content => {
Â  Â  Â  Â  Â  Â  Â  Â  content.classList.add('hidden');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById(`${tabName}-content`).classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  });
}

function setupSorting() {
Â  Â  document.querySelectorAll('.table-header-sortable').forEach(header => {
Â  Â  Â  Â  header.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const column = header.dataset.sort;
Â  Â  Â  Â  Â  Â  if (sortState.column === column) {
Â  Â  Â  Â  Â  Â  Â  Â  sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  sortState.column = column;
Â  Â  Â  Â  Â  Â  Â  Â  sortState.direction = 'desc';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderHoldingsTable();
Â  Â  Â  Â  });
Â  Â  });
}

function setupFiltering() {
Â  Â  const filterButtons = document.querySelectorAll('.filter-btn');
Â  Â  filterButtons.forEach(button => {
Â  Â  Â  Â  button.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const filter = button.dataset.filter;
Â  Â  Â  Â  Â  Â  filterButtons.forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('bg-indigo-100', 'text-indigo-700');
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('bg-gray-100', 'text-gray-700');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  button.classList.add('bg-indigo-100', 'text-indigo-700');
Â  Â  Â  Â  Â  Â  button.classList.remove('bg-gray-100', 'text-gray-700');
Â  Â  Â  Â  Â  Â  renderActionsTable(filter);
Â  Â  Â  Â  });
Â  Â  });
}

function renderHoldingsTable() {
Â  Â  const tableBody = document.getElementById('holdingsTableBody');
Â  Â  const sortedData = [...portfolioData].sort((a, b) => {
Â  Â  Â  Â  const valA = a[sortState.column];
Â  Â  Â  Â  const valB = b[sortState.column];
Â  Â  Â  Â  if (valA === null || valA === undefined) return 1;
Â  Â  Â  Â  if (valB === null || valB === undefined) return -1;
Â  Â  Â  Â  if (sortState.direction === 'asc') {
Â  Â  Â  Â  Â  Â  return typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  return typeof valA === 'string' ? valB.localeCompare(valA) : valB - valA;
Â  Â  Â  Â  }
Â  Â  });
Â  Â  tableBody.innerHTML = sortedData.map((item, index) => `
Â  Â  Â  Â  <tr class="bg-white border-b hover:bg-gray-50">
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 font-medium text-gray-700">${index + 1}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 font-medium text-gray-900 whitespace-nowrap">${item.scrip}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4">${item.quantity}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 text-gray-500">${item.purchasePrice.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4">${item.ltp.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4">${item.currentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 text-gray-500">${item.purchaseValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 font-medium ${item.profitOrLoss >= 0 ? 'profit' : 'loss'}">${item.profitOrLoss.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 font-medium ${item.profitOrLossPercent >= 0 ? 'profit' : 'loss'}">${item.profitOrLossPercent.toFixed(2)}%</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4">${item.weight.toFixed(2)}%</td>
Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-btn text-red-500 hover:text-red-700" data-scrip="${item.scrip}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');
}

function renderActionsTable(filter = 'all') {
Â  Â  const tableBody = document.getElementById('actionsTableBody');
Â  Â  const sortedData = [...portfolioData].sort((a,b) => b.currentValue - a.currentValue);
Â  Â  const filteredData = filter === 'all' 
Â  Â  Â  Â  ? sortedData
Â  Â  Â  Â  : sortedData.filter(item => item.recommendation === filter);
Â  Â  tableBody.innerHTML = filteredData.map(item => `
Â  Â  Â  Â  Â <tr class="bg-white border-b hover:bg-gray-50">
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.scrip}</td>
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4">${item.sector}</td>
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 font-medium ${item.profitOrLossPercent >= 0 ? 'profit' : 'loss'}">${item.profitOrLossPercent.toFixed(2)}%</td>
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-2 py-1 text-xs font-medium rounded-full action-${item.recommendation.toLowerCase()}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.recommendation}
Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-xs">${item.rationale}</td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');
}

function setupAIButton() {
Â  Â  const generateBtn = document.getElementById('generateStrategyBtn');
Â  Â  const outputDiv = document.getElementById('strategyOutput');
Â  Â  generateBtn.addEventListener('click', async () => {
Â  Â  Â  Â  generateBtn.disabled = true;
Â  Â  Â  Â  generateBtn.innerHTML = 'Generating Strategy...';
Â  Â  Â  Â  outputDiv.innerHTML = `<p>Analyzing your updated portfolio and generating a new strategic plan... <span class="inline-block border-r-2 border-indigo-500 h-4 w-1 -mb-1 blinking-cursor"></span></p>`;
Â  Â  Â  Â  
Â  Â  Â  Â  const holdingsSummary = portfolioData.slice(0, 10).map(p => `${p.scrip} (${p.sector}, P/L: ${p.profitOrLossPercent.toFixed(2)}%)`).join(', ');
Â  Â  Â  Â  
Â  Â  Â  Â  const prompt = `
Â  Â  Â  Â  Â  Â  Analyze the following updated NEPSE portfolio with Profit/Loss data and provide a high-level strategic plan.
Â  Â  Â  Â  Â  Â  The portfolio has a total value of NPR ${document.getElementById('totalValue').textContent}, based on a total investment of NPR ${document.getElementById('totalInvestment').textContent}, resulting in a total profit/loss of ${document.getElementById('totalPL').textContent}.
Â  Â  Â  Â  Â  Â  The portfolio contains 36 holdings. The top holdings by value now include: ${holdingsSummary}.
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Key Insights from P/L Data:
Â  Â  Â  Â  Â  Â  - The new high-quality additions (SHIVM, DDBL) are performing well.
Â  Â  Â  Â  Â  Â  - Several stocks in the "SELL" list are showing significant losses, validating the recommendation to divest.
Â  Â  Â  Â  Â  Â  - The portfolio complexity (36 stocks) is hiding both winners and losers.

Â  Â  Â  Â  Â  Â  Based on this performance data, generate a strategic plan focusing on these clear actions:
Â  Â  Â  Â  Â  Â  1. Â Accelerate Cleanup of Losing Positions: Emphasize the urgency of selling the "red" stocks. Which specific losing stocks should be the absolute first priority to sell to stop further losses and free up capital?
Â  Â  Â  Â  Â  Â  2. Â Capital Re-Deployment into Winners: The capital raised from selling losers should not sit idle. Should it be redeployed into the existing profitable core holdings (like SHIVM, DDBL, HDL) to compound gains?
Â  Â  Â  Â  Â  Â  3. Â The "Reduce" Category: How should the P/L data affect the "REDUCE" recommendations for stocks like HRL? Does a profit in these suggest taking it, and a loss suggest cutting the position?
Â  Â  Â  Â  Â  Â  4. Â Future Vision: Reiterate the goal of a focused portfolio of 10-12 high-quality companies, emphasizing that this cleanup is the path to achieving that.
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Present the output in markdown format with clear headings for each section.
Â  Â  Â  Â  `;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  let chatHistory = [];
Â  Â  Â  Â  Â  Â  chatHistory.push({ role: "user", parts: [{ text: prompt }] });
Â  Â  Â  Â  Â  Â  const payload = { contents: chatHistory };
Â  Â  Â  Â  Â  Â  const apiKey = ""; 
Â  Â  Â  Â  Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;

Â  Â  Â  Â  Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`API request failed with status ${response.status}`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  Â  Â  if (result.candidates && result.candidates.length > 0 &&
Â  Â  Â  Â  Â  Â  Â  Â  result.candidates[0].content && result.candidates[0].content.parts &&
Â  Â  Â  Â  Â  Â  Â  Â  result.candidates[0].content.parts.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  let text = result.candidates[0].content.parts[0].text;
Â  Â  Â  Â  Â  Â  Â  Â  text = text.replace(/### (.*)/g, '<h3>$1</h3>')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/\* (.*)/g, '<li>$1</li>')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/(<\/li\>)\n<li\>/g, '$1</li><li>')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
Â  Â  Â  Â  Â  Â  Â  Â  outputDiv.innerHTML = text;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â outputDiv.innerHTML = '<p class="text-red-500">Sorry, the AI could not generate a strategy at this time. The response was empty.</p>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error calling Gemini API:', error);
Â  Â  Â  Â  Â  Â  outputDiv.innerHTML = `<p class="text-red-500">An error occurred while generating the strategy. Please check the console for details.</p>`;
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  generateBtn.disabled = false;
Â  Â  Â  Â  Â  Â  generateBtn.innerHTML = 'Generate Portfolio Strategy';
Â  Â  Â  Â  }
Â  Â  });
}
</script>