<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive NEPSE Portfolio Dashboard with P/L Tracking (Dark Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Dark Mode Theme --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray Background */
            color: #d1d5db; /* Light Gray Text */
        }
        .card, .section {
            background-color: #1f2937; /* Lighter Dark Gray for cards */
            border: 1px solid #374151; /* Medium Gray Border */
        }
        .tab-active {
            border-bottom: 2px solid #6366f1; /* Brighter Indigo for active tab */
            color: #818cf8;
            font-weight: 600;
        }
        .tab-inactive {
            color: #9ca3af; /* Lighter gray for inactive tabs */
        }
        .table-header-sortable {
            cursor: pointer;
            transition: color 0.2s;
        }
        .table-header-sortable:hover {
            color: #818cf8; /* Brighter Indigo on hover */
        }
        /* Action Tags with dark backgrounds */
        .action-hold { background-color: rgba(99, 102, 241, 0.2); border: 1px solid rgba(99, 102, 241, 0.5); color: #c7d2fe; }
        .action-reduce { background-color: rgba(252, 211, 77, 0.2); border: 1px solid rgba(252, 211, 77, 0.5); color: #fde68a; }
        .action-sell { background-color: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.5); color: #fecaca; }
        
        .profit { color: #4ade80; } /* Brighter Green for profit */
        .loss { color: #f87171; } /* Brighter Red for loss */

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .blinking-cursor {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { border-right-color: transparent; }
            50% { border-right-color: #818cf8; }
        }
        .strategy-output h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #e5e7eb;
        }
        .strategy-output ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-100">NEPSE Portfolio Analysis</h1>
                <p id="dashboardDate" class="text-gray-400 mt-1">Interactive Dashboard</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="syncLtpBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:bg-green-800 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10.899 12.101a7.002 7.002 0 01-11.601-2.566 1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101z" clip-rule="evenodd" /></svg>
                    <span id="syncBtnText">Sync Live Prices</span>
                </button>
                <button id="openModalBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add New Stock
                </button>
            </div>
        </header>

        <main>
            <!-- Portfolio Performance Metrics -->
            <section id="metrics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card p-6 rounded-xl shadow-lg">
                    <h3 class="text-sm font-medium text-gray-400">Total Portfolio Value</h3>
                    <p id="totalValue" class="text-2xl font-semibold text-gray-100 mt-2">NPR 0.00</p>
                </div>
                <div class="card p-6 rounded-xl shadow-lg">
                    <h3 class="text-sm font-medium text-gray-400">Total Investment</h3>
                    <p id="totalInvestment" class="text-2xl font-semibold text-gray-100 mt-2">NPR 0.00</p>
                </div>
                <div class="card p-6 rounded-xl shadow-lg">
                    <h3 class="text-sm font-medium text-gray-400">Total Profit/Loss</h3>
                    <p id="totalPL" class="text-2xl font-semibold text-gray-100 mt-2">NPR 0.00</p>
                </div>
                <div class="card p-6 rounded-xl shadow-lg">
                    <h3 class="text-sm font-medium text-gray-400">Portfolio Return %</h3>
                    <p id="portfolioReturn" class="text-2xl font-semibold text-gray-100 mt-2">0.00%</p>
                </div>
            </section>
            
            <!-- AI Strategy Section -->
            <section id="ai-strategy" class="section p-6 rounded-xl shadow-lg mb-8 fade-in">
                <h2 class="text-xl font-semibold text-gray-100 mb-2">âœ¨ AI-Powered Strategy</h2>
                <p class="text-gray-400 mb-4">Click the button below to get a high-level strategic plan from our AI assistant based on your portfolio's current state and performance.</p>
                <button id="generateStrategyBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center disabled:bg-indigo-800">
                    Generate Portfolio Strategy
                </button>
                <div id="strategyOutput" class="mt-4 text-gray-300 leading-relaxed strategy-output">
                    <!-- AI generated content will appear here -->
                </div>
            </section>

            <!-- Tabs -->
            <div class="border-b border-gray-700 mb-6">
                <nav class="flex space-x-6" id="tabs">
                    <button data-tab="overview" class="py-3 px-1 text-sm font-medium tab-active">Portfolio Overview</button>
                    <button data-tab="actions" class="py-3 px-1 text-sm font-medium tab-inactive">Action Plan</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Overview Tab -->
                <div id="overview-content" class="fade-in">
                    <div class="section p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-100 mb-1">Holdings Details & Performance</h2>
                        <p class="text-sm text-gray-400 mb-4">Click on column headers to sort the table by performance metrics.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">SN</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="scrip">Scrip</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="quantity">Shares</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="purchasePrice">Purchase Price</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="ltp">LTP</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="currentValue">Current Value</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="purchaseValue">Total Investment</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="profitOrLoss">P/L (NPR)</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="profitOrLossPercent">P/L (%)</th>
                                        <th scope="col" class="px-4 py-3 table-header-sortable" data-sort="weight">Weight (%)</th>
                                        <th scope="col" class="px-4 py-3">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="holdingsTableBody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Action Plan Tab -->
                <div id="actions-content" class="hidden fade-in">
                    <div class="section p-6 rounded-xl shadow-lg">
                        <div class="flex flex-wrap items-center justify-between mb-4 gap-4">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-100">Recommended Actions</h2>
                                <p class="text-sm text-gray-400 mt-1">Filter actions to focus on de-risking and optimization, considering performance.</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-filter="all" class="filter-btn bg-indigo-500 text-white px-3 py-1.5 text-sm rounded-full font-medium">All</button>
                                <button data-filter="HOLD" class="filter-btn bg-gray-700 text-gray-200 px-3 py-1.5 text-sm rounded-full font-medium">Hold</button>
                                <button data-filter="REDUCE" class="filter-btn bg-gray-700 text-gray-200 px-3 py-1.5 text-sm rounded-full font-medium">Reduce</button>
                                <button data-filter="SELL" class="filter-btn bg-gray-700 text-gray-200 px-3 py-1.5 text-sm rounded-full font-medium">Sell</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Scrip</th>
                                        <th scope="col" class="px-6 py-3">Sector</th>
                                        <th scope="col" class="px-6 py-3">P/L (%)</th>
                                        <th scope="col" class="px-6 py-3">Recommendation</th>
                                        <th scope="col" class="px-6 py-3">Key Rationale & Alerts</th>
                                    </tr>
                                </thead>
                                <tbody id="actionsTableBody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>This report is generated for informational purposes only based on the data provided and public market information.</p>
            <p>It does not constitute financial advice. Please consult with a qualified financial advisor before making any investment decisions.</p>
        </footer>
    </div>
    
    <!-- Add Stock Modal -->
    <div id="addStockModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-100">Add New Stock</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="addStockForm">
                <div class="space-y-4">
                    <div>
                        <label for="scrip" class="block text-sm font-medium text-gray-300 mb-1">Scrip (Ticker)</label>
                        <input type="text" id="scrip" name="scrip" placeholder="e.g., NTC" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="shares" class="block text-sm font-medium text-gray-300 mb-1">Number of Shares</label>
                        <input type="number" id="shares" name="shares" placeholder="e.g., 100" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-300 mb-1">Purchase Price per Share</label>
                        <input type="number" id="price" name="price" step="0.01" placeholder="e.g., 750.50" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="mt-8">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Add Stock to Portfolio</button>
                </div>
            </form>
        </div>
    </div>

<script>
// --- DATA STORE ---
let portfolioData = [
    { scrip: 'SHIVM', sector: 'Manufacturing And Processing', quantity: 190, purchasePrice: 515, ltp: 515, recommendation: 'HOLD', rationale: 'Newly added blue-chip manufacturing stock. Excellent for diversification.' },
    { scrip: 'DDBL', sector: 'Microfinance', quantity: 120, purchasePrice: 780, ltp: 782.11, recommendation: 'HOLD', rationale: 'High-quality MFI. Core holding for the sector.' },
    { scrip: 'AKJCL', sector: 'Hydro Power', quantity: 200, purchasePrice: 211.90, ltp: 209.88, recommendation: 'HOLD', rationale: 'New holding. Monitor speculative P/E and dilutive rights issue.' },
    { scrip: 'HDL', sector: 'Manufacturing And Processing', quantity: 43, purchasePrice: 1181.36, ltp: 1209, recommendation: 'HOLD', rationale: 'Excellent fundamentals, key diversifier.' },
    { scrip: 'KBL', sector: 'Commercial Banks', quantity: 100, purchasePrice: 213.05, ltp: 219, recommendation: 'SELL', rationale: 'Consolidate banking exposure to simplify.' },
    { scrip: 'SKBBL', sector: 'Microfinance', quantity: 39, purchasePrice: 668.17, ltp: 840, recommendation: 'HOLD', rationale: 'Strongest MFI holding, consistent dividends.' },
    { scrip: 'RSDC', sector: 'Microfinance', quantity: 39, purchasePrice: 409.62, ltp: 732, recommendation: 'REDUCE', rationale: 'Reduce to consolidate capital into stronger MFIs.' },
    { scrip: 'GBIME', sector: 'Commercial Banks', quantity: 300, purchasePrice: 222.33, ltp: 230, recommendation: 'HOLD', rationale: 'Core holding, but monitor high NPLs (4.98%).' },
    { scrip: 'FMDBL', sector: 'Microfinance', quantity: 17, purchasePrice: 474.93, ltp: 809, recommendation: 'SELL', rationale: 'ðŸ”´ Extreme P/E. High risk. Sell to de-risk.' },
    { scrip: 'SRLI', sector: 'Life Insurance', quantity: 20, purchasePrice: 100, ltp: 446.8, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
    { scrip: 'NBF2', sector: 'Mutual Fund', quantity: 100, purchasePrice: 10, ltp: 9.45, recommendation: 'SELL', rationale: 'Position size is too small to have any impact.' },
    { scrip: 'HRL', sector: 'Others', quantity: 31, purchasePrice: 202.58, ltp: 1029.9, recommendation: 'REDUCE', rationale: 'ðŸŸ¡ Valuation Risk: High P/E suggests speculation.' },
    { scrip: 'HLI', sector: 'Life Insurance', quantity: 23, purchasePrice: 100.45, ltp: 431, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
    { scrip: 'GCIL', sector: 'Manufacturing And Processing', quantity: 11, purchasePrice: 404.55, ltp: 577.5, recommendation: 'SELL', rationale: 'ðŸ”´ Negative Earnings: Unprofitable company.' },
    { scrip: 'CLI', sector: 'Life Insurance', quantity: 10, purchasePrice: 244, ltp: 721.5, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
    { scrip: 'USHEC', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 696, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
    { scrip: 'UPPER', sector: 'Hydro Power', quantity: 80, purchasePrice: 100, ltp: 209.7, recommendation: 'SELL', rationale: 'Sell to reduce overall hydropower exposure.' },
    { scrip: 'UPCL', sector: 'Hydro Power', quantity: 54, purchasePrice: 100, ltp: 306.9, recommendation: 'REDUCE', rationale: 'Reduce exposure to hydropower sector policy risk.' },
    { scrip: 'UAIL', sector: 'Non-Life Insurance', quantity: 27, purchasePrice: 428.7, ltp: 703, recommendation: 'HOLD', rationale: 'Provides diversification into the non-life space.' },
    { scrip: 'SNLI', sector: 'Life Insurance', quantity: 10, purchasePrice: 239, ltp: 725, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
    { scrip: 'SJCL', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 356, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
    { scrip: 'SGHC', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 577, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
    { scrip: 'RNLI', sector: 'Life Insurance', quantity: 11, purchasePrice: 100, ltp: 567, recommendation: 'SELL', rationale: 'Consolidate life insurance holdings.' },
    { scrip: 'RHGCL', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 652, recommendation: 'SELL', rationale: 'ðŸ”´ Negative Earnings & Dilution Risk.' },
    { scrip: 'PRVU', sector: 'Commercial Banks', quantity: 366, purchasePrice: 142.45, ltp: 231.1, recommendation: 'HOLD', rationale: 'Core bank, but watch asset quality issues.' },
    { scrip: 'PPCL', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 320, recommendation: 'SELL', rationale: 'Small holding in a company with a history of losses.' },
    { scrip: 'PMLI', sector: 'Life Insurance', quantity: 32, purchasePrice: 496.24, ltp: 587.9, recommendation: 'SELL', rationale: 'ðŸ”´ Zero Earnings: No fundamental reason to hold.' },
    { scrip: 'NMB', sector: 'Commercial Banks', quantity: 133, purchasePrice: 231.31, ltp: 263, recommendation: 'SELL', rationale: 'Consolidate banking exposure into stronger core holdings.' },
    { scrip: 'NIMB', sector: 'Commercial Banks', quantity: 300, purchasePrice: 194.63, ltp: 229, recommendation: 'HOLD', rationale: 'Strong fundamentals, attractive valuation.' },
    { scrip: 'NIFRA', sector: 'Investment', quantity: 183, purchasePrice: 339.8, ltp: 296, recommendation: 'HOLD', rationale: 'Strategic asset, successful Green Bond issue.' },
    { scrip: 'NICLBSL', sector: 'Microfinance', quantity: 10, purchasePrice: 100, ltp: 707.7, recommendation: 'SELL', rationale: 'ðŸ”´ Extreme Valuation: P/E over 6000 is a major red flag.' },
    { scrip: 'JOSHI', sector: 'Hydro Power', quantity: 20, purchasePrice: 100, ltp: 414.5, recommendation: 'SELL', rationale: 'Non-strategic, small holding in a high-risk sector.' },
    { scrip: 'GLH', sector: 'Hydro Power', quantity: 10, purchasePrice: 100, ltp: 270.1, recommendation: 'SELL', rationale: 'Small, non-strategic hydro holding.' },
    { scrip: 'AVYAN', sector: 'Microfinance', quantity: 10, purchasePrice: 100, ltp: 1199, recommendation: 'SELL', rationale: 'ðŸ”´ Very high P/E ratio. Sell to reduce risk.' }
];

let sortState = {
    column: 'currentValue',
    direction: 'desc'
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', async () => {
    setDashboardDate();
    await fetchLtpFromApi(false);
    setupEventListeners();
});

// --- CORE FUNCTIONS ---
function runAllCalculations() {
    calculatePortfolioMetrics();
    renderHoldingsTable();
    renderActionsTable();
}

function setupEventListeners() {
    setupTabs();
    setupSorting();
    setupFiltering();
    setupAIButton();
    setupModal();
    setupAddStockForm();
    setupDeleteStock();
    setupApiSync();
}

function calculatePortfolioMetrics() {
    let totalCurrentValue = 0;
    let totalPurchaseValue = 0;

    portfolioData.forEach(item => {
        item.purchaseValue = item.quantity * item.purchasePrice;
        item.currentValue = item.quantity * item.ltp;
        item.profitOrLoss = item.currentValue - item.purchaseValue;
        item.profitOrLossPercent = item.purchaseValue > 0 ? (item.profitOrLoss / item.purchaseValue) * 100 : 0;
        totalCurrentValue += item.currentValue;
        totalPurchaseValue += item.purchaseValue;
    });

    portfolioData.forEach(item => {
        item.weight = totalCurrentValue > 0 ? (item.currentValue / totalCurrentValue) * 100 : 0;
    });

    const totalPL = totalCurrentValue - totalPurchaseValue;
    const portfolioReturn = totalPurchaseValue > 0 ? (totalPL / totalPurchaseValue) * 100 : 0;

    document.getElementById('totalValue').textContent = `NPR ${totalCurrentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('totalInvestment').textContent = `NPR ${totalPurchaseValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    
    const totalPLElement = document.getElementById('totalPL');
    totalPLElement.textContent = `NPR ${totalPL.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    totalPLElement.className = `text-2xl font-semibold mt-2 ${totalPL >= 0 ? 'profit' : 'loss'}`;

    const portfolioReturnElement = document.getElementById('portfolioReturn');
    portfolioReturnElement.textContent = `${portfolioReturn.toFixed(2)}%`;
    portfolioReturnElement.className = `text-2xl font-semibold mt-2 ${portfolioReturn >= 0 ? 'profit' : 'loss'}`;
}

function renderHoldingsTable() {
    const tableBody = document.getElementById('holdingsTableBody');
    const sortedData = [...portfolioData].sort((a, b) => {
        const valA = a[sortState.column];
        const valB = b[sortState.column];
        if (valA === null || valA === undefined) return 1;
        if (valB === null || valB === undefined) return -1;
        if (sortState.direction === 'asc') {
            return typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
        } else {
            return typeof valA === 'string' ? valB.localeCompare(valA) : valB - valA;
        }
    });
    tableBody.innerHTML = sortedData.map((item, index) => `
        <tr class="border-b border-gray-700 hover:bg-gray-800">
            <td class="px-4 py-4 font-medium text-gray-300">${index + 1}</td>
            <td class="px-4 py-4 font-medium text-gray-100 whitespace-nowrap">${item.scrip}</td>
            <td class="px-4 py-4">${item.quantity.toLocaleString('en-IN')}</td>
            <td class="px-4 py-4 text-gray-400">${item.purchasePrice.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="px-4 py-4">${item.ltp.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="px-4 py-4">${item.currentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="px-4 py-4 text-gray-400">${item.purchaseValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="px-4 py-4 font-medium ${item.profitOrLoss >= 0 ? 'profit' : 'loss'}">${item.profitOrLoss.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="px-4 py-4 font-medium ${item.profitOrLossPercent >= 0 ? 'profit' : 'loss'}">${item.profitOrLossPercent.toFixed(2)}%</td>
            <td class="px-4 py-4">${item.weight.toFixed(2)}%</td>
            <td class="px-4 py-4 text-center">
                <button class="delete-btn text-red-500 hover:text-red-400" data-scrip="${item.scrip}" aria-label="Delete ${item.scrip}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            </td>
        </tr>
    `).join('');
}

function renderActionsTable(filter = 'all') {
    const tableBody = document.getElementById('actionsTableBody');
    const sortedData = [...portfolioData].sort((a,b) => b.currentValue - a.currentValue);
    const filteredData = filter === 'all' 
        ? sortedData
        : sortedData.filter(item => item.recommendation === filter);
    tableBody.innerHTML = filteredData.map(item => `
        <tr class="border-b border-gray-700 hover:bg-gray-800">
            <td class="px-6 py-4 font-medium text-gray-100 whitespace-nowrap">${item.scrip}</td>
            <td class="px-6 py-4">${item.sector}</td>
            <td class="px-6 py-4 font-medium ${item.profitOrLossPercent >= 0 ? 'profit' : 'loss'}">${item.profitOrLossPercent.toFixed(2)}%</td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full action-${item.recommendation.toLowerCase()}">
                    ${item.recommendation}
                </span>
            </td>
            <td class="px-6 py-4 text-xs">${item.rationale}</td>
        </tr>
    `).join('');
}

// --- EVENT LISTENER SETUP ---
function setupModal() {
    const modal = document.getElementById('addStockModal');
    const openBtn = document.getElementById('openModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.classList.add('hidden');
        }
    });
}

function setupAddStockForm() {
    const form = document.getElementById('addStockForm');
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const scripInput = document.getElementById('scrip');
        const sharesInput = document.getElementById('shares');
        const priceInput = document.getElementById('price');
        
        const newStock = {
            scrip: scripInput.value.toUpperCase().trim(),
            sector: 'Uncategorized',
            quantity: parseFloat(sharesInput.value),
            purchasePrice: parseFloat(priceInput.value),
            ltp: parseFloat(priceInput.value),
            recommendation: 'HOLD',
            rationale: 'Newly added stock. Analysis pending.'
        };

        if (newStock.scrip && !isNaN(newStock.quantity) && newStock.quantity > 0 && !isNaN(newStock.purchasePrice) && newStock.purchasePrice > 0) {
            portfolioData.push(newStock);
            runAllCalculations();
            form.reset();
            document.getElementById('addStockModal').classList.add('hidden');
        } else {
            alert('Please fill in all fields with valid numbers.');
        }
    });
}

function setupDeleteStock() {
    const tableBody = document.getElementById('holdingsTableBody');
    tableBody.addEventListener('click', (e) => {
        const deleteButton = e.target.closest('.delete-btn');
        if (deleteButton) {
            const scripToDelete = deleteButton.dataset.scrip;
            if (confirm(`Are you sure you want to delete ${scripToDelete}?`)) {
                 portfolioData = portfolioData.filter(stock => stock.scrip !== scripToDelete);
                 runAllCalculations();
            }
        }
    });
}

function setupTabs() {
    const tabs = document.getElementById('tabs');
    const tabContent = document.getElementById('tab-content');
    tabs.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const tabName = e.target.dataset.tab;
            tabs.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            e.target.classList.add('tab-active');
            e.target.classList.remove('tab-inactive');
            tabContent.querySelectorAll(':scope > div').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
        }
    });
}

function setupSorting() {
    document.querySelectorAll('.table-header-sortable').forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.sort;
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'desc';
            }
            renderHoldingsTable();
        });
    });
}

function setupFiltering() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            const filter = button.dataset.filter;
            filterButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-500', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-200');
            });
            button.classList.add('bg-indigo-500', 'text-white');
            button.classList.remove('bg-gray-700', 'text-gray-200');
            renderActionsTable(filter);
        });
    });
}

// --- API INTERACTIONS ---
function setupApiSync() {
    const syncBtn = document.getElementById('syncLtpBtn');
    syncBtn.addEventListener('click', () => fetchLtpFromApi(true));
}

async function fetchLtpFromApi(showAlerts = true) {
    const syncBtn = document.getElementById('syncLtpBtn');
    const syncBtnText = document.getElementById('syncBtnText');
    const originalBtnText = 'Sync Live Prices';

    syncBtn.disabled = true;
    syncBtnText.textContent = 'Syncing...';

    try {
        const response = await fetch('https://nepsefloorsheetapi.onrender.com/api/v1/share-prices');
        if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }
        const apiData = await response.json();
        
        if (!Array.isArray(apiData) || apiData.length === 0) {
            if (showAlerts) alert("Received no data from the API. Displaying last known values.");
            return;
        }

        const priceMap = new Map();
        apiData.forEach(item => {
            const symbol = item.Symbol;
            const ltp = parseFloat(String(item.LTP).replace(/,/g, ''));
            if (symbol && !isNaN(ltp)) {
                priceMap.set(symbol, ltp);
            }
        });
        
        let updatedCount = 0;
        portfolioData.forEach(stock => {
            if (priceMap.has(stock.scrip)) {
                stock.ltp = priceMap.get(stock.scrip);
                updatedCount++;
            }
        });

        if (showAlerts) {
            if (updatedCount > 0) {
                alert(`${updatedCount} stock(s) updated successfully with the latest prices.`);
            } else {
                alert("No matching stocks found in the live data to update.");
            }
        }
    } catch (error) {
        console.error('Failed to fetch live prices:', error);
        if (showAlerts) {
            alert(`Could not fetch live prices. Please check your connection or try again later.\nError: ${error.message}`);
        }
    } finally {
        runAllCalculations();
        syncBtn.disabled = false;
        syncBtnText.textContent = originalBtnText;
    }
}

function setupAIButton() {
    const generateBtn = document.getElementById('generateStrategyBtn');
    const outputDiv = document.getElementById('strategyOutput');
    generateBtn.addEventListener('click', async () => {
        generateBtn.disabled = true;
        generateBtn.innerHTML = 'Generating Strategy...';
        outputDiv.innerHTML = `<p>Analyzing your updated portfolio and generating a new strategic plan... <span class="inline-block border-r-2 border-indigo-400 h-4 w-1 -mb-1 blinking-cursor"></span></p>`;
        
        const holdingsSummary = portfolioData.slice(0, 10).map(p => `${p.scrip} (${p.sector}, P/L: ${p.profitOrLossPercent.toFixed(2)}%)`).join(', ');
        
        const prompt = `
            Analyze the following updated NEPSE portfolio with Profit/Loss data and provide a high-level strategic plan.
            The portfolio has a total value of ${document.getElementById('totalValue').textContent}, based on a total investment of ${document.getElementById('totalInvestment').textContent}, resulting in a total profit/loss of ${document.getElementById('totalPL').textContent}.
            The portfolio contains ${portfolioData.length} holdings. The top holdings by value now include: ${holdingsSummary}.
            
            Key Insights from P/L Data:
            - The new high-quality additions (SHIVM, DDBL) are performing well.
            - Several stocks in the "SELL" list are showing significant losses, validating the recommendation to divest.
            - The portfolio complexity (${portfolioData.length} stocks) is hiding both winners and losers.

            Based on this performance data, generate a strategic plan focusing on these clear actions:
            1.  Accelerate Cleanup of Losing Positions: Emphasize the urgency of selling the "red" stocks. Which specific losing stocks should be the absolute first priority to sell to stop further losses and free up capital?
            2.  Capital Re-Deployment into Winners: The capital raised from selling losers should not sit idle. Should it be redeployed into the existing profitable core holdings (like SHIVM, DDBL, HDL) to compound gains?
            3.  The "Reduce" Category: How should the P/L data affect the "REDUCE" recommendations for stocks like HRL? Does a profit in these suggest taking it, and a loss suggest cutting the position?
            4.  Future Vision: Reiterate the goal of a focused portfolio of 10-12 high-quality companies, emphasizing that this cleanup is the path to achieving that.
            
            Present the output in markdown format with clear headings for each section (e.g., ### Section Title).
        `;

        try {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                let text = result.candidates[0].content.parts[0].text;
                text = text.replace(/### (.*)/g, '<h3>$1</h3>')
                           .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                           .replace(/^\* (.*$)/gm, '<li>$1</li>')
                           .replace(/(\<\/li\>)\n<li>/g, '</li><li>')
                           .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                outputDiv.innerHTML = text;
            } else {
                 outputDiv.innerHTML = '<p class="text-red-500">Sorry, the AI could not generate a strategy at this time. The response was empty.</p>';
            }
        } catch (error) {
            console.error('Error calling Gemini API:', error);
            outputDiv.innerHTML = `<p class="text-red-500">An error occurred while generating the strategy. Please check the console for details.</p>`;
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'Generate Portfolio Strategy';
        }
    });
}

// --- UTILITY FUNCTIONS ---
function setDashboardDate() {
    const dateElement = document.getElementById('dashboardDate');
    const today = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    dateElement.textContent = `As of ${today.toLocaleDateString('en-US', options)}`;
}

</script>
</body>
</html>
